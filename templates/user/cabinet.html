{% extends "main_template.html" %}

{% block title %}Личный кабинет {{ user.get_username }}{% endblock %}

{% block content %}

<div class="row">
    <div class="col-xs-12 col-md-12">
        <article id="post-20" class="post-20 page type-page status-publish hentry">
            <div class="row">
                <table>
                    <tr>
                        <td valign="top">
                            <div class="col-4">
                                <div class="list-group" id="list-tab" role="tablist" style="width: 250px; padding-right: 40px">
                                    <a class="list-group-item list-group-item-action active" id="list-personal-data-list" data-toggle="list" href="#list-personal-data" role="tab" aria-controls="personal-data">Личные данные</a>

                                    <a class="list-group-item list-group-item-action" id="list-settings-list" data-toggle="list" href="#list-settings" role="tab" aria-controls="settings">Настройки</a>

                                    <a class="list-group-item list-group-item-action" id="list-pay-in-list" data-toggle="list" href="#list-pay-in" role="tab" aria-controls="pay-in">Пополнить счет</a>

                                    <a class="list-group-item list-group-item-action" id="list-buy-premium-list" data-toggle="list" href="#list-buy-premium" role="tab" aria-controls="buy-premium">Купить ПРЕМИУМ</a>
                                </div>
                            </div>
                        </td>
                        <td valign="top">
                            <div class="col-8" style="">
                                <div class="tab-content" id="nav-tabContent">
                                    <div id="personal-data-tabpanel">
                                        <form action="/save-personal-data/" id="personal-data-form" method="POST" enctype="multipart/form-data">
                                            {% csrf_token %}
                                            <div>
                                                {% if user.profile.avatar %}
                                                <img id="avatar-upload" src="{{ user.profile.avatar }}" style="width:200px; height:200px; float:left; margin-left: 20px; margin-right: 20px"> 
                                                {% else %}
                                                <img id="avatar-upload" src="/static/includes/images/avatar-default.png" style="width:200px; height:200px; float:left; margin-left: 20px; margin-right: 20px"> 
                                                {% endif %}
                                                <input type="file" accept="image/*" class="custom-file-input" name="avatar" id="id_avatar">
                                            </div>
                                            <table class="data-table">
                                                <tr>
                                                    <td>
                                                        <div class="lwa-username">
                                                            <div>
                                                                <span class="input-group-text" id="basic-addon1">Имя:</span>
                                                                <br>
                                                                <input style="width: 200px" class="form-control" placeholder="Иван" type="text" name="first_name" autofocus required maxlength="50" id="id_first_name" value="{{ user.first_name }}">
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <div>
                                                            <div>
                                                                <span class="input-group-text" id="basic-addon1">Фамилия:</span>
                                                                <br>
                                                                <input type="text" name="last_name" class="form-control" placeholder="Иванов" maxlength="50" required id="id_last_name" value="{{ user.last_name }}">
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        <div>
                                                            <div>
                                                                <span class="input-group-text" id="basic-addon1">Био:</span>
                                                                <br>
                                                                <input class="form-control" name="bio" id="id_bio" value="{{ user.profile.bio }}" />
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        <div>
                                                            <div>
                                                                <br>
                                                                <div id="save-data-status" style="color:red" hidden></div>
                                                                <br>
                                                                <input type="submit" id="save-data" value="Сохранить" tabindex="100" />
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </table>
                                        </form>
                                    </div>

                                    <div id="settings-tabpanel" hidden>
                                        <table class="data-table">
                                            <tr>
                                                <td valign="top">
                                                    <form method="post" id="new_password_form">
                                                        {% csrf_token %}
                                                        <div class="username_input">
                                                            <input type="password" style="width:300px" name="new_password1" placeholder="Введите новый пароль" class="form-control" />
                                                        </div>
                                                        <br>
                                                        <div class="username_input">
                                                            <input type="password" style="width:300px" name="new_password2" placeholder="Введите новый пароль еще раз" class="form-control" />
                                                        </div>
                                                        <br>
                                                        <div id="password-errors" style="color:red"></div>
                                                        <input type="submit" value="Изменить пароль" id="password-button" style="width:200px;">
                                                    </form>
                                                </td>
                                                <td valign="top">
                                                    <form id="new-email-form" method="post">
                                                        <p> Ваш email: {{ user.email }} </p>
                                                        {% csrf_token %}
                                                        <div>
                                                            <div id="new-email">
                                                                <div>
                                                                    <input type="text" class="form-control" name="email" id="email-field" placeholder="Введите новый email" required />
                                                                </div>
                                                            </div>
                                                            <div>
                                                                <div>
                                                                    <br>
                                                                    <div id="new-email-status" hidden></div>
                                                                    <input id="new-email-button" type="submit" value="Изменить email" />
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </form>

                                                </td>
                                            </tr>
                                        </table>
                                    </div>

                                    <div id="pay-in-tabpanel" hidden>Пополнить счет</div>
                                    <div id="buy-premium-tabpanel" hidden>Купить ПРЕМИУМ</div>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>

        </article>
    </div>
</div>
</div>
</section>

<script>
function readURL(input) {
if (input.files && input.files[0]) {
    var reader = new FileReader();

    reader.onload = function(e) {
        $('#avatar-upload').attr('src', e.target.result);
    }

    reader.readAsDataURL(input.files[0]);
}
}

$("#id_avatar").change(function() {
readURL(this);
});

/*$("#save-data").on("click", function(i) {
$("#save-data-status").hide();
i.preventDefault();
$.ajax({
    type: "POST",
    url: '/save-personal-data/',
    data: {
        'form': $("#personal-data-form").serialize(),
        'file': $("#id_avatar").val(),
        'csrfmiddlewaretoken': $("input[name=csrfmiddlewaretoken]").val(),
    },
    success: function(response) {
        if (response === "Success!") {
            $("#save-data-status").show();
            $("#save-data-status").css("color", "green");
            $("#save-data-status").html("Успешно сохранено");
        } else {
            $("#save-data-status").show();
            $("#save-data-status").html("Произошла ошибка");
        }
    }
});
});
*/
$("#password-button").on("click", function(i) {
$('#password-errors').hide()
i.preventDefault();
$.ajax({
    type: "POST",
    url: '/change-cabinet-password/',
    data: $("#new_password_form").serialize(),
    success: function(response) {
        // do something with response
        if (response['result'] === "Success!") {
            $("#password-errors").show();
            $("#password-errors").css("color", "green");
            $('#password-errors').html("Успешно сохранено");
        } else {
            $('#password-errors').html(response["result"]);
            $('#password-errors').show()
        }
    }
});
});

$("#new-email-button").on("click", function(i) {
$('#new-email-status').hide()
i.preventDefault();
$.ajax({
    type: "POST",
    url: '/change-email/',
    data: $("#new-email-form").serialize(),
    success: function(response) {
        if (response == "Success!") {
            $("#new-email-status").show();
            $("#new-email-status").css("color", "green");
            $('#new-email-status').html("Активация была отправлена на указанный эмейл");
        } else {
            $("#new-email-status").show();
            $("#new-email-status").css("color", "red");
            $('#new-email-status').html(response);
        }
    }
});
});

$("#list-personal-data-list").on("click", function() {
$("#settings-tabpanel").hide();
$("#pay-in-tabpanel").hide();
$("#buy-premium-tabpanel").hide();
$("#personal-data-tabpanel").show("slow");

$("#list-settings-list").removeClass("active");
$("#list-pay-in-list").removeClass("active");
$("#list-buy-premium-list").removeClass("active");
$(this).addClass("active");
});

$("#list-settings-list").on("click", function() {
$("#pay-in-tabpanel").hide();
$("#buy-premium-tabpanel").hide();
$("#personal-data-tabpanel").hide();
$("#settings-tabpanel").show("slow");

$("#list-personal-data-list").removeClass("active");
$("#list-pay-in-list").removeClass("active");
$("#list-buy-premium-list").removeClass("active");
$(this).addClass("active");
});

$("#list-pay-in-list").on("click", function() {
$("#buy-premium-tabpanel").hide();
$("#personal-data-tabpanel").hide();
$("#settings-tabpanel").hide();
$("#pay-in-tabpanel").show("slow");

$("#list-personal-data-list").removeClass("active");
$("#list-settings-list").removeClass("active");
$("#list-buy-premium-list").removeClass("active");
$(this).addClass("active");
});

$("#list-buy-premium-list").on("click", function() {
$("#personal-data-tabpanel").hide();
$("#settings-tabpanel").hide();
$("#pay-in-tabpanel").hide();
$("#buy-premium-tabpanel").show("slow");

$("#list-personal-data-list").removeClass("active");
$("#list-settings-list").removeClass("active");
$("#list-pay-in-list").removeClass("active");
$(this).addClass("active");
});
</script>


{% endblock %}